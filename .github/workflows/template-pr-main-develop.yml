name: "Template - PR Main ‚Üí Develop after Hotfix"

on:
  workflow_call:
    secrets:
      GH_TOKEN:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  pr-main-develop:
    runs-on: ubuntu-latest
    # Seguran√ßa extra: s√≥ roda em PR mergeado de hotfix/*
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'hotfix/')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Check if develop is behind main
        id: diff
        run: |
          git fetch origin develop
          if git diff --quiet origin/main origin/develop; then
            echo "no_diff=true" >> "$GITHUB_OUTPUT"
          else
            echo "no_diff=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR Main ‚Üí Develop
        if: steps.diff.outputs.no_diff == 'false'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          EXISTING_PR=$(gh pr list --base develop --head main --state open --json number --jq '.[0].number')
          
          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --base develop \
              --head main \
              --title "develop ‚Üê main (hotfix sync)" \
              --body "üîÑ Sincroniza√ß√£o autom√°tica ap√≥s hotfix \`${{ github.event.pull_request.head.ref }}\`"
            echo "‚úÖ PR criado com sucesso!"
          else
            echo "‚ö†Ô∏è PR #$EXISTING_PR j√° existe"
          fi