name: "Template - PR Hotfix ‚Üí Main"

on:
  workflow_call:
    secrets:
      GH_TOKEN:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Analyze commits and bump patch version
        id: version
        run: |
          git fetch origin main
          git checkout origin/main -- .version 2>/dev/null || echo "1.0.0" > .version
          
          BASE_VERSION=$(sed 's/-.*//' .version)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"
          
          PATCH=$((PATCH+1))
          HOTFIX_VERSION="$MAJOR.$MINOR.$PATCH-HOTFIX"
          
          echo "$HOTFIX_VERSION" > .version
          echo "version=$HOTFIX_VERSION" >> "$GITHUB_OUTPUT"
          echo "üöë Hotfix version: $HOTFIX_VERSION"

      - name: Commit .version
        run: |
          # Volta para a branch do hotfix
          git checkout "${GITHUB_REF#refs/heads/}"
          git add .version
          git commit -m "chore: bump hotfix version to ${{ steps.version.outputs.version }} [skip ci]" || echo "No changes"
          git push origin HEAD

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          BRANCH_NAME: ${{ github.ref_name }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          EXISTING_PR=$(gh pr list --base main --head "$BRANCH_NAME" --state open --json number --jq '.[0].number')
          
          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --base main \
              --head "$BRANCH_NAME" \
              --title "üöë Hotfix: $BRANCH_NAME ‚Üí main" \
              --body "## üöë Hotfix Urgente
              
          **Vers√£o:** \`$VERSION\`  
          **Branch:** \`$BRANCH_NAME\`  
          **Target:** \`main\`
          
          ---
          _Hotfix autom√°tico - requer aprova√ß√£o urgente_"
            echo "‚úÖ PR criado com sucesso!"
          else
            echo "‚ö†Ô∏è PR #$EXISTING_PR j√° existe"
          fi
