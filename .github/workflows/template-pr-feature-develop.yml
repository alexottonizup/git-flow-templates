name: "Template - PR Feature ‚Üí Develop"

on:
  workflow_call:
    secrets:
      GH_TOKEN:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Analyze commits and determine version bump
        id: version
        run: |
          # Vers√£o base atual
          if [ -f ".version" ]; then
            BASE_VERSION=$(sed 's/-.*//' .version)
          else
            BASE_VERSION="1.0.0"
          fi

          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"

          # Commits desde develop
          git fetch origin develop
          COMMITS=$(git log origin/develop..HEAD --pretty=format:"%s" || echo "")

          BUMP_TYPE="patch"
          
          if echo "$COMMITS" | grep -qE "^feat!:|BREAKING CHANGE:"; then
            BUMP_TYPE="major"
          elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
            BUMP_TYPE="minor"
          elif echo "$COMMITS" | grep -qE "^fix(\(.+\))?:"; then
            BUMP_TYPE="patch"
          fi

          case $BUMP_TYPE in
            major)
              MAJOR=$((MAJOR+1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR+1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH+1))
              ;;
          esac

          NEXT_VERSION="$MAJOR.$MINOR.$PATCH-SNAPSHOT"
          echo "$NEXT_VERSION" > .version
          echo "version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
          echo "bump_type=$BUMP_TYPE" >> "$GITHUB_OUTPUT"
          echo "üì¶ Pr√≥xima vers√£o: $NEXT_VERSION (bump: $BUMP_TYPE)"

      - name: Commit .version
        run: |
          git add .version
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }} [skip ci]" || echo "No changes"
          git push origin HEAD

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          BRANCH_NAME: ${{ github.ref_name }}
          VERSION: ${{ steps.version.outputs.version }}
          BUMP_TYPE: ${{ steps.version.outputs.bump_type }}
        run: |
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --base develop --state open --json number --jq '.[0].number')
          
          if [ -n "$EXISTING_PR" ]; then
            echo "‚úÖ PR #$EXISTING_PR j√° existe"
            exit 0
          fi
          
          gh pr create \
            --base develop \
            --head "$BRANCH_NAME" \
            --title "develop ‚Üê $BRANCH_NAME" \
            --body "üöÄ **Vers√£o:** \`$VERSION\`  
          **Tipo de bump:** \`$BUMP_TYPE\`  
          **Branch:** \`$BRANCH_NAME\`  
          **Target:** \`develop\`
          
          ---
          _PR criado automaticamente pelo workflow_"
          
          echo "‚úÖ PR criado com sucesso!"